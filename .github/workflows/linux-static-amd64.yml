name: Build Linux static binary amd64 (Alpine)

on:
  workflow_dispatch:

jobs:
  build-static-amd64:
    runs-on: ubuntu-latest

    container:
      image: alpine:latest
      options: --privileged

    steps:
      - name: Install build dependencies
        run: |
          apk update
          apk add --no-cache \
            git make cmake gcc g++ musl-dev openssl-dev openssl-libs-static

      - name: Checkout source
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'

      - name: Build static hashsumr
        env:
          CC: gcc
        run: |
          make hashsumr-static
          strip hashsumr-static
          mv hashsumr-static hashsumr-linux-amd64-static

      - name: Verify static binary
        run: |
          file hashsumr-linux-amd64-static
          ldd hashsumr-linux-amd64-static || echo "static binary (expected)"

      - name: Upload static binary (artifact)
        uses: actions/upload-artifact@v4
        with:
          name: hashsumr-linux-amd64-static
          path: hashsumr-linux-amd64-static

