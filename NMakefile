CC      = cl
AR      = lib
CFLAGS  = /nologo /utf-8 /W4 /Zi /MD /guard:cf /permissive-
LDFLAGS = /link /DYNAMICBASE /NXCOMPAT /HIGHENTROPYVA /TSAWARE /DEBUG
# no /APPCONTAINER

PROGS   = hashsumr.exe launcher.exe

HASHSUMR_OBJS    = main.obj loadcheck.obj hashsumr.obj getopt.obj wrappers-openssl.obj wrappers-blake3.obj wrappers-win32.obj

MINIBAR_OBJS	= minibar.obj
PTHREAD_COMPAT_OBJS	= pthread_barrier.obj pthread_win32.obj

all: $(PROGS)

blake3/blake3.lib:
	@-mkdir blake3-src\c\build
	cd blake3-src/c/build && cmake .. -G "NMake Makefiles" \
		-DCMAKE_BUILD_TYPE=Release -DCMAKE_MSVC_RUNTIME_LIBRARY=MultiThreadedDLL && nmake
	@-mkdir blake3
	copy blake3-src\c\blake3.h .\blake3
	copy blake3-src\c\build\blake3.lib .\blake3
	-rmdir /s /q blake3-src\c\build

minibar.obj: minibar/minibar.c
	$(CC) $(CFLAGS) /c /Fo$@ $**

pthread_barrier.obj: minibar/pthread_compat/pthread_barrier.c
	$(CC) $(CFLAGS) /c /Fo$@ $**

pthread_win32.obj: minibar/pthread_compat/pthread_win32.c
	$(CC) $(CFLAGS) /c /Fo$@ $**

.c.obj:
	$(CC) $(CFLAGS) /c /Fo$@ $**

hashsumr.exe: blake3/blake3.lib $(HASHSUMR_OBJS) $(MINIBAR_OBJS) $(PTHREAD_COMPAT_OBJS)
	$(CC) $(CFLAGS) /Fe:$@ $(HASHSUMR_OBJS) $(MINIBAR_OBJS) $(PTHREAD_COMPAT_OBJS) $(LDFLAGS) blake3/blake3.lib bcrypt.lib user32.lib

launcher.exe: launcher.obj
	$(CC) $(CFLAGS) /Fe: $@ launcher.obj $(LDFLAGS) user32.lib

clean:
	-del /Q *.obj *.exe *.lib *.pdb *.ilk
	-rmdir /S /Q blake3

# debugging: devenv /debugexe main.exe
